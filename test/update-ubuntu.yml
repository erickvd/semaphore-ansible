---
# playbook_update_ubuntu.yml

- name: Mise √† jour des machines Ubuntu
  hosts: "{{ HOSTS | default([]) }}"
  become: true

  tasks:
    # ‚îÄ‚îÄ T√¢ches communes aux deux groupes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: Mise √† jour du cache apt
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Mise √† jour de tous les paquets
      ansible.builtin.apt:
        upgrade: dist
        autoremove: true
        autoclean: true
      register: apt_result
      async: 1800
      poll: 30

    - name: V√©rification si un reboot est n√©cessaire
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required

    # ‚îÄ‚îÄ Bloc sp√©cifique aux serveurs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: T√¢ches sp√©cifiques aux serveurs
      when: "'ubuntu_servers' in group_names or 'proxmox_servers' in group_names"
      block:

#        - name: "[Serveurs] Afficher un avertissement si un reboot est n√©cessaire"
#          ansible.builtin.debug:
#            msg: >
#              ‚ö†Ô∏è  REBOOT REQUIS sur {{ inventory_hostname }} !
#              Veuillez red√©marrer manuellement d√®s que possible.
#          when: reboot_required.stat.exists

        - name: "[Serveurs] Afficher les paquets mis √† jour"
          vars:
            paquets: "{{ apt_result.stdout_lines | select('match', '^Inst ') | map('regex_replace', '^Inst (\\S+).*', '\\1') | list }}"
            resume: "{{ apt_result.stdout_lines | select('match', '^\\d+ upgraded') | list | first | default('') }}"
          ansible.builtin.debug:
            msg:
              - "üì¶ Mise √† jour sur {{ inventory_hostname }}"
              - "Paquets : {{ paquets | join(', ') }}"
              - "R√©sum√©  : {{ resume }}"
          when: apt_result.changed
          # noqa: no-handler

    # ‚îÄ‚îÄ Bloc sp√©cifique aux desktops ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: T√¢ches sp√©cifiques aux desktops
      when: "'ubuntu_desktops' in group_names"
      block:

        - name: "[Desktops] Mise √† jour des snaps (si snapd est install√©)"
          community.general.snap:
            name: "*"
            state: present
          when: ansible_facts.packages['snapd'] is defined

        - name: "[Desktops] Lire les paquets n√©cessitant un reboot"
          ansible.builtin.slurp:
            src: /var/run/reboot-required.pkgs
          register: reboot_pkgs
          when: reboot_required.stat.exists

        - name: "[Desktops] Afficher les paquets mis √† jour"
          vars:
            paquets: "{{ apt_result.stdout_lines | select('match', '^Inst ') | map('regex_replace', '^Inst (\\S+).*', '\\1') | list }}"
            resume: "{{ apt_result.stdout_lines | select('match', '^\\d+ upgraded') | list | first | default('') }}"
          ansible.builtin.debug:
            msg:
              - "üì¶ Mise √† jour sur {{ inventory_hostname }}"
              - "Paquets : {{ paquets | join(', ') }}"
              - "R√©sum√©  : {{ resume }}"
          when: apt_result.changed
          # noqa: no-handler

    - name: "Afficher un avertissement si un reboot est n√©cessaire"
      ansible.builtin.debug:
        msg: >
          ‚ö†Ô∏è  REBOOT REQUIS sur {{ inventory_hostname }} !
          Paquets concern√©s : {{ reboot_pkgs.stdout_lines | default(['inconnu']) }}
      when: reboot_required.stat.exists
